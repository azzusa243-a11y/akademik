<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Akademik - Prodi Bisnis Digital</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #666;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            margin-left: 10px;
            width: auto;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-info {
            background: #17a2b8;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        /* Dashboard Styles */
        .dashboard {
            display: none;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .sidebar {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar li {
            border-bottom: 1px solid #eee;
        }

        .sidebar li:last-child {
            border-bottom: none;
        }

        .sidebar a {
            display: block;
            padding: 15px 20px;
            text-decoration: none;
            color: #333;
            transition: background-color 0.3s;
        }

        .sidebar a:hover, .sidebar a.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .main-content {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .content-area {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 500px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 4px;
            width: auto;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        /* Print Styles */
        .print-area {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .kop-surat {
            text-align: center;
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .signature-area {
            display: flex;
            justify-content: space-between;
            margin-top: 50px;
            padding: 20px 0;
        }

        .signature-box {
            text-align: center;
            width: 200px;
        }

        .signature-line {
            border-top: 1px solid #333;
            margin-top: 80px;
            padding-top: 10px;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .print-area, .print-area * {
                visibility: visible;
            }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }

        .hidden {
            display: none;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .data-controls {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                order: 2;
            }
            
            .content-area {
                order: 1;
            }
            
            .login-box {
                width: 90%;
            }

            .data-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <h1>SISTEM AKADEMIK</h1>
                <p>Program Studi Bisnis Digital</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" required>
                </div>
                <div class="form-group">
                    <label>Login Sebagai</label>
                    <select id="userRole" required>
                        <option value="">Pilih Role</option>
                        <option value="admin">Administrator</option>
                        <option value="mahasiswa">Mahasiswa</option>
                    </select>
                </div>
                <button type="submit" class="btn">LOGIN</button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardPage" class="dashboard">
        <div class="container">
            <div class="header">
                <h1>Sistem Akademik - Prodi Bisnis Digital</h1>
                <div class="user-info">
                    <span id="currentUser">Welcome, User</span>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>

            <div class="main-content">
                <div class="sidebar">
                    <ul id="menuList">
                        <li><a href="#" onclick="showSection('dashboard')" class="active">Dashboard</a></li>
                        <li class="admin-only"><a href="#" onclick="showSection('dataMahasiswa')">Data Mahasiswa</a></li>
                        <li class="admin-only"><a href="#" onclick="showSection('kurikulum')">Kurikulum</a></li>
                        <li><a href="#" onclick="showSection('krs')">KRS</a></li>
                        <li class="admin-only"><a href="#" onclick="showSection('pengisianNilai')">Pengisian Nilai</a></li>
                        <li><a href="#" onclick="showSection('khs')">KHS</a></li>
                        <li><a href="#" onclick="showSection('transkrip')">Transkrip Nilai</a></li>
                        <li class="admin-only"><a href="#" onclick="showSection('cetak')">Cetak Dokumen</a></li>
                        <li class="admin-only"><a href="#" onclick="showSection('pengaturan')">Pengaturan</a></li>
                    </ul>
                </div>

                <div class="content-area">
                    <!-- Dashboard Section -->
                    <div id="dashboard" class="section active">
                        <h2>Dashboard</h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3 id="totalMahasiswa">0</h3>
                                <p>Total Mahasiswa</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="totalMataKuliah">0</h3>
                                <p>Mata Kuliah</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="semesterAktif">2024/2025-1</h3>
                                <p>Semester Aktif</p>
                            </div>
                        </div>
                        <div id="studentDashboard" class="hidden">
                            <h3>Informasi Mahasiswa</h3>
                            <p><strong>NIM:</strong> <span id="studentNim">-</span></p>
                            <p><strong>Nama:</strong> <span id="studentName">-</span></p>
                            <p><strong>Angkatan:</strong> <span id="studentAngkatan">-</span></p>
                            <p><strong>Semester:</strong> <span id="studentSemester">-</span></p>
                        </div>
                    </div>

                    <!-- Data Mahasiswa Section -->
                    <div id="dataMahasiswa" class="section">
                        <h2>Data Mahasiswa</h2>
                        <div class="data-controls">
                            <button class="btn" onclick="openModal('addMahasiswaModal')">Tambah Mahasiswa</button>
                            <button class="btn btn-warning" onclick="resetMahasiswaData()">Reset Data</button>
                            <button class="btn btn-info" onclick="exportMahasiswaData()">Export Data</button>
                        </div>
                        <table id="mahasiswaTable">
                            <thead>
                                <tr>
                                    <th>NIM</th>
                                    <th>Nama</th>
                                    <th>Angkatan</th>
                                    <th>Semester</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="mahasiswaTableBody">
                                <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Kurikulum Section -->
                    <div id="kurikulum" class="section">
                        <h2>Kurikulum</h2>
                        <div class="data-controls">
                            <button class="btn" onclick="openModal('addMataKuliahModal')">Tambah Mata Kuliah</button>
                            <button class="btn btn-warning" onclick="resetKurikulumData()">Reset Data</button>
                            <button class="btn btn-info" onclick="exportKurikulumData()">Export Data</button>
                        </div>
                        <table id="kurikulumTable">
                            <thead>
                                <tr>
                                    <th>Kode</th>
                                    <th>Nama Mata Kuliah</th>
                                    <th>SKS</th>
                                    <th>Semester</th>
                                    <th>Prasyarat</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="kurikulumTableBody">
                                <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- KRS Section -->
                    <div id="krs" class="section">
                        <h2>Kartu Rencana Studi (KRS)</h2>
                        <div id="krsAdmin">
                            <div class="form-group">
                                <label>Pilih Mahasiswa</label>
                                <select id="krsMahasiswa" onchange="loadKRSForStudent()">
                                    <option value="">Pilih Mahasiswa</option>
                                </select>
                            </div>
                        </div>
                        <div id="krsContent">
                            <h3>Mata Kuliah Tersedia</h3>
                            <table id="availableMataKuliah">
                                <thead>
                                    <tr>
                                        <th>Pilih</th>
                                        <th>Kode</th>
                                        <th>Nama Mata Kuliah</th>
                                        <th>SKS</th>
                                        <th>Semester</th>
                                    </tr>
                                </thead>
                                <tbody id="availableMataKuliahBody">
                                </tbody>
                            </table>
                            <button class="btn" onclick="saveKRS()" style="margin-top: 20px;">Simpan KRS</button>
                        </div>
                    </div>

                    <!-- Pengisian Nilai Section -->
                    <div id="pengisianNilai" class="section">
                        <h2>Pengisian Nilai</h2>
                        <div class="form-group">
                            <label>Angkatan</label>
                            <select id="nilaiAngkatan" onchange="loadNilaiData()">
                                <option value="">Pilih Angkatan</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                                <option value="2022">2022</option>
                                <option value="2021">2021</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Semester</label>
                            <select id="nilaiSemester" onchange="loadNilaiData()">
                                <option value="">Pilih Semester</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Mata Kuliah</label>
                            <select id="nilaiMataKuliah" onchange="loadNilaiData()">
                                <option value="">Pilih Mata Kuliah</option>
                            </select>
                        </div>
                        <div id="nilaiContent" style="display: none;">
                            <table id="nilaiTable">
                                <thead>
                                    <tr>
                                        <th>NIM</th>
                                        <th>Nama</th>
                                        <th>Nilai</th>
                                        <th>Grade</th>
                                    </tr>
                                </thead>
                                <tbody id="nilaiTableBody">
                                </tbody>
                            </table>
                            <button class="btn" onclick="saveNilai()" style="margin-top: 20px;">Simpan Nilai</button>
                        </div>
                    </div>

                    <!-- KHS Section -->
                    <div id="khs" class="section">
                        <h2>Kartu Hasil Studi (KHS)</h2>
                        <div id="khsAdmin">
                            <div class="form-group">
                                <label>Pilih Mahasiswa</label>
                                <select id="khsMahasiswa" onchange="loadKHS()">
                                    <option value="">Pilih Mahasiswa</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Semester</label>
                                <select id="khsSemester" onchange="loadKHS()">
                                    <option value="">Pilih Semester</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                </select>
                            </div>
                        </div>
                        <div id="khsContent" style="display: none;">
                            <table id="khsTable">
                                <thead>
                                    <tr>
                                        <th>Kode</th>
                                        <th>Mata Kuliah</th>
                                        <th>SKS</th>
                                        <th>Nilai</th>
                                        <th>Grade</th>
                                    </tr>
                                </thead>
                                <tbody id="khsTableBody">
                                </tbody>
                            </table>
                            <div id="khsSummary" style="margin-top: 20px;">
                                <p><strong>Total SKS:</strong> <span id="totalSKS">0</span></p>
                                <p><strong>IPK Semester:</strong> <span id="ipkSemester">0.00</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Transkrip Section -->
                    <div id="transkrip" class="section">
                        <h2>Transkrip Nilai</h2>
                        <div id="transkripAdmin">
                            <div class="form-group">
                                <label>Pilih Mahasiswa</label>
                                <select id="transkripMahasiswa" onchange="loadTranskrip()">
                                    <option value="">Pilih Mahasiswa</option>
                                </select>
                            </div>
                        </div>
                        <div id="transkripContent" style="display: none;">
                            <table id="transkripTable">
                                <thead>
                                    <tr>
                                        <th>Semester</th>
                                        <th>Kode</th>
                                        <th>Mata Kuliah</th>
                                        <th>SKS</th>
                                        <th>Nilai</th>
                                        <th>Grade</th>
                                    </tr>
                                </thead>
                                <tbody id="transkripTableBody">
                                </tbody>
                            </table>
                            <div id="transkripSummary" style="margin-top: 20px;">
                                <p><strong>Total SKS:</strong> <span id="totalSKSTranskrip">0</span></p>
                                <p><strong>IPK Kumulatif:</strong> <span id="ipkKumulatif">0.00</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Cetak Section -->
                    <div id="cetak" class="section">
                        <h2>Cetak Dokumen</h2>
                        <div class="form-group">
                            <label>Jenis Dokumen</label>
                            <select id="jenisCetak">
                                <option value="">Pilih Dokumen</option>
                                <option value="dataMahasiswa">Data Mahasiswa</option>
                                <option value="krs">KRS</option>
                                <option value="khs">KHS</option>
                                <option value="transkrip">Transkrip</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Mahasiswa</label>
                            <select id="cetakMahasiswa">
                                <option value="">Pilih Mahasiswa</option>
                            </select>
                        </div>
                        <button class="btn" onclick="generatePDF()">Generate PDF</button>
                        <div id="printPreview" class="print-area" style="display: none;">
                            <!-- Preview akan muncul di sini -->
                        </div>
                    </div>

                    <!-- Pengaturan Section -->
                    <div id="pengaturan" class="section">
                        <h2>Pengaturan Sistem</h2>
                        
                        <h3>Kelola User</h3>
                        <div class="data-controls">
                            <button class="btn" onclick="openModal('addUserModal')">Tambah User</button>
                            <button class="btn btn-warning" onclick="resetUserData()">Reset User</button>
                        </div>
                        <table id="userTable">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="userTableBody">
                            </tbody>
                        </table>

                        <h3 style="margin-top: 30px;">Pengaturan Kop Surat</h3>
                        <button class="btn" onclick="openModal('editKopModal')">Edit Kop Surat</button>
                        
                        <h3 style="margin-top: 30px;">Backup & Restore</h3>
                        <div class="data-controls">
                            <button class="btn btn-success" onclick="downloadBackup()">Download Backup</button>
                            <input type="file" id="backupFile" accept=".json" style="display: none;" onchange="uploadBackup()">
                            <button class="btn btn-info" onclick="document.getElementById('backupFile').click()">Upload Backup</button>
                            <button class="btn btn-danger" onclick="resetAllData()">Reset Semua Data</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Mahasiswa Modal -->
    <div id="addMahasiswaModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addMahasiswaModal')">&times;</span>
            <h3>Tambah Mahasiswa</h3>
            <form id="addMahasiswaForm">
                <div class="form-group">
                    <label>NIM</label>
                    <input type="text" id="newNim" required>
                </div>
                <div class="form-group">
                    <label>Nama</label>
                    <input type="text" id="newNama" required>
                </div>
                <div class="form-group">
                    <label>Angkatan</label>
                    <input type="number" id="newAngkatan" required>
                </div>
                <div class="form-group">
                    <label>Semester</label>
                    <input type="number" id="newSemester" min="1" max="8" required>
                </div>
                <button type="submit" class="btn">Simpan</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('addMahasiswaModal')">Batal</button>
            </form>
        </div>
    </div>

    <!-- Add Mata Kuliah Modal -->
    <div id="addMataKuliahModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addMataKuliahModal')">&times;</span>
            <h3>Tambah Mata Kuliah</h3>
            <form id="addMataKuliahForm">
                <div class="form-group">
                    <label>Kode</label>
                    <input type="text" id="newKodeMK" required>
                </div>
                <div class="form-group">
                    <label>Nama Mata Kuliah</label>
                    <input type="text" id="newNamaMK" required>
                </div>
                <div class="form-group">
                    <label>SKS</label>
                    <input type="number" id="newSKS" min="1" max="6" required>
                </div>
                <div class="form-group">
                    <label>Semester</label>
                    <input type="number" id="newSemesterMK" min="1" max="8" required>
                </div>
                <div class="form-group">
                    <label>Prasyarat</label>
                    <input type="text" id="newPrasyarat" placeholder="Kosongkan jika tidak ada">
                </div>
                <button type="submit" class="btn">Simpan</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('addMataKuliahModal')">Batal</button>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addUserModal')">&times;</span>
            <h3>Tambah User</h3>
            <form id="addUserForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="newUsername" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="newPassword" required>
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="newRole" required>
                        <option value="">Pilih Role</option>
                        <option value="admin">Admin</option>
                        <option value="mahasiswa">Mahasiswa</option>
                    </select>
                </div>
                <button type="submit" class="btn">Simpan</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('addUserModal')">Batal</button>
            </form>
        </div>
    </div>

    <!-- Edit Kop Modal -->
    <div id="editKopModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editKopModal')">&times;</span>
            <h3>Edit Kop Surat</h3>
            <form id="editKopForm">
                <div class="form-group">
                    <label>Nama Institusi</label>
                    <input type="text" id="namaInstitusi" value="UNIVERSITAS DIGITAL INDONESIA">
                </div>
                <div class="form-group">
                    <label>Program Studi</label>
                    <input type="text" id="namaProdi" value="PROGRAM STUDI BISNIS DIGITAL">
                </div>
                <div class="form-group">
                    <label>Alamat</label>
                    <textarea id="alamatInstitusi" rows="3">Jl. Digital No. 123, Jakarta 12345</textarea>
                </div>
                <div class="form-group">
                    <label>Nama Kaprodi</label>
                    <input type="text" id="namaKaprodi" value="Dr. John Doe, M.Kom">
                </div>
                <button type="submit" class="btn">Simpan</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('editKopModal')">Batal</button>
            </form>
        </div>
    </div>

    <script>
        // Data Storage Keys
        const STORAGE_KEYS = {
            mahasiswa: 'akademik_mahasiswa_data',
            mataKuliah: 'akademik_mata_kuliah_data',
            users: 'akademik_users_data',
            krs: 'akademik_krs_data',
            nilai: 'akademik_nilai_data',
            kopSurat: 'akademik_kop_surat_data',
            initialized: 'akademik_system_initialized'
        };

        // Global Variables
        let currentUser = null;
        let currentRole = null;
        
        // Data Arrays
        let mahasiswaData = [];
        let mataKuliahData = [];
        let userData = [];
        let krsData = {};
        let nilaiData = {};
        let kopSurat = {};

        // Data Management Functions
        function saveToStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                alert('Error menyimpan data: ' + error.message);
                return false;
            }
        }

        function loadFromStorage(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                return null;
            }
        }

        function saveAllData() {
            saveToStorage(STORAGE_KEYS.mahasiswa, mahasiswaData);
            saveToStorage(STORAGE_KEYS.mataKuliah, mataKuliahData);
            saveToStorage(STORAGE_KEYS.users, userData);
            saveToStorage(STORAGE_KEYS.krs, krsData);
            saveToStorage(STORAGE_KEYS.nilai, nilaiData);
            saveToStorage(STORAGE_KEYS.kopSurat, kopSurat);
        }

        function loadAllData() {
            const savedMahasiswa = loadFromStorage(STORAGE_KEYS.mahasiswa);
            const savedMataKuliah = loadFromStorage(STORAGE_KEYS.mataKuliah);
            const savedUsers = loadFromStorage(STORAGE_KEYS.users);
            const savedKrs = loadFromStorage(STORAGE_KEYS.krs);
            const savedNilai = loadFromStorage(STORAGE_KEYS.nilai);
            const savedKopSurat = loadFromStorage(STORAGE_KEYS.kopSurat);

            if (savedMahasiswa) mahasiswaData = savedMahasiswa;
            if (savedMataKuliah) mataKuliahData = savedMataKuliah;
            if (savedUsers) userData = savedUsers;
            if (savedKrs) krsData = savedKrs;
            if (savedNilai) nilaiData = savedNilai;
            if (savedKopSurat) kopSurat = savedKopSurat;
        }

        function initializeDefaultData() {
            const isInitialized = localStorage.getItem(STORAGE_KEYS.initialized);
            
            if (!isInitialized) {
                // Initialize default data only on first run
                mahasiswaData = [
                    {nim: '2024001', nama: 'Ahmad Rizki', angkatan: 2024, semester: 1, status: 'Aktif', password: 'mahasiswa123'},
                    {nim: '2024002', nama: 'Siti Nurhaliza', angkatan: 2024, semester: 1, status: 'Aktif', password: 'mahasiswa123'},
                    {nim: '2023001', nama: 'Budi Santoso', angkatan: 2023, semester: 3, status: 'Aktif', password: 'mahasiswa123'},
                    {nim: '2023002', nama: 'Dewi Kartika', angkatan: 2023, semester: 3, status: 'Aktif', password: 'mahasiswa123'},
                    {nim: '2022001', nama: 'Eko Prasetyo', angkatan: 2022, semester: 5, status: 'Aktif', password: 'mahasiswa123'}
                ];

                mataKuliahData = [
                    {kode: 'BD101', nama: 'Pengantar Bisnis Digital', sks: 3, semester: 1, prasyarat: '-'},
                    {kode: 'BD102', nama: 'Matematika Bisnis', sks: 3, semester: 1, prasyarat: '-'},
                    {kode: 'BD103', nama: 'Pengantar Teknologi Informasi', sks: 3, semester: 1, prasyarat: '-'},
                    {kode: 'BD201', nama: 'E-Commerce', sks: 3, semester: 2, prasyarat: 'BD101'},
                    {kode: 'BD202', nama: 'Digital Marketing', sks: 3, semester: 2, prasyarat: 'BD101'},
                    {kode: 'BD301', nama: 'Data Analytics', sks: 3, semester: 3, prasyarat: 'BD102'},
                    {kode: 'BD302', nama: 'Business Intelligence', sks: 3, semester: 3, prasyarat: 'BD301'}
                ];

                userData = [
                    {username: 'admin', password: 'admin123', role: 'admin', status: 'Aktif'},
                    {username: '2024001', password: 'mahasiswa123', role: 'mahasiswa', status: 'Aktif'},
                    {username: '2024002', password: 'mahasiswa123', role: 'mahasiswa', status: 'Aktif'},
                    {username: '2023001', password: 'mahasiswa123', role: 'mahasiswa', status: 'Aktif'},
                    {username: '2023002', password: 'mahasiswa123', role: 'mahasiswa', status: 'Aktif'},
                    {username: '2022001', password: 'mahasiswa123', role: 'mahasiswa', status: 'Aktif'}
                ];

                kopSurat = {
                    namaInstitusi: 'UNIVERSITAS DIGITAL INDONESIA',
                    namaProdi: 'PROGRAM STUDI BISNIS DIGITAL',
                    alamat: 'Jl. Digital No. 123, Jakarta 12345',
                    kaprodi: 'Dr. John Doe, M.Kom'
                };

                // Initialize sample KRS and grades
                krsData = {
                    '2024001': {
                        '1': ['BD101', 'BD102', 'BD103']
                    },
                    '2024002': {
                        '1': ['BD101', 'BD102']
                    },
                    '2023001': {
                        '1': ['BD101', 'BD102', 'BD103'],
                        '2': ['BD201', 'BD202'],
                        '3': ['BD301']
                    }
                };

                nilaiData = {
                    '2024001': {
                        'BD101': 85,
                        'BD102': 78,
                        'BD103': 92
                    },
                    '2023001': {
                        'BD101': 88,
                        'BD102': 82,
                        'BD103': 90,
                        'BD201': 85,
                        'BD202': 80,
                        'BD301': 87
                    }
                };

                // Save all initial data
                saveAllData();
                localStorage.setItem(STORAGE_KEYS.initialized, 'true');
            } else {
                // Load existing data
                loadAllData();
            }
        }

        // Login Function
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const role = document.getElementById('userRole').value;
            
            // Find user in userData
            const user = userData.find(u => u.username === username && u.password === password && u.role === role);
            
            if (user) {
                if (role === 'admin') {
                    currentUser = 'Administrator';
                } else {
                    const mahasiswa = mahasiswaData.find(m => m.nim === username);
                    currentUser = mahasiswa ? mahasiswa.nama : username;
                }
                currentRole = role;
                showDashboard();
            } else {
                alert('Username, password, atau role salah!');
            }
        });

        // Show Dashboard
        function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboardPage').style.display = 'block';
            document.getElementById('currentUser').textContent = `Welcome, ${currentUser}`;
            
            // Hide admin-only menus for mahasiswa
            if (currentRole === 'mahasiswa') {
                const adminMenus = document.querySelectorAll('.admin-only');
                adminMenus.forEach(menu => menu.style.display = 'none');
                
                document.getElementById('studentDashboard').classList.remove('hidden');
                const mahasiswa = mahasiswaData.find(m => m.nama === currentUser);
                if (mahasiswa) {
                    document.getElementById('studentNim').textContent = mahasiswa.nim;
                    document.getElementById('studentName').textContent = mahasiswa.nama;
                    document.getElementById('studentAngkatan').textContent = mahasiswa.angkatan;
                    document.getElementById('studentSemester').textContent = mahasiswa.semester;
                }
            } else {
                document.getElementById('studentDashboard').classList.add('hidden');
            }
            
            loadDashboardData();
            refreshAllTables();
            populateSelectors();
        }

        // Logout Function
        function logout() {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                currentUser = null;
                currentRole = null;
                document.getElementById('loginPage').style.display = 'block';
                document.getElementById('dashboardPage').style.display = 'none';
                document.getElementById('loginForm').reset();
                
                // Reset form visibility
                const adminMenus = document.querySelectorAll('.admin-only');
                adminMenus.forEach(menu => menu.style.display = 'block');
                document.getElementById('studentDashboard').classList.add('hidden');
                
                // Reset active section
                showSection('dashboard');
            }
        }

        // Show Section
        function showSection(sectionId) {
            // Hide all sections
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => section.classList.remove('active'));
            
            // Remove active class from all menu items
            const menuItems = document.querySelectorAll('.sidebar a');
            menuItems.forEach(item => item.classList.remove('active'));
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Add active class to clicked menu item
            const targetMenu = document.querySelector(`[onclick="showSection('${sectionId}')"]`);
            if (targetMenu) {
                targetMenu.classList.add('active');
            }
            
            // Load section-specific data
            switch(sectionId) {
                case 'dataMahasiswa':
                    loadMahasiswaTable();
                    break;
                case 'kurikulum':
                    loadKurikulumTable();
                    break;
                case 'krs':
                    loadKRSData();
                    break;
                case 'pengisianNilai':
                    loadPengisianNilaiData();
                    break;
                case 'khs':
                    loadKHSData();
                    break;
                case 'transkrip':
                    loadTranskripData();
                    break;
                case 'cetak':
                    loadCetakData();
                    break;
                case 'pengaturan':
                    loadPengaturanData();
                    break;
            }
        }

        // Load Dashboard Data
        function loadDashboardData() {
            document.getElementById('totalMahasiswa').textContent = mahasiswaData.length;
            document.getElementById('totalMataKuliah').textContent = mataKuliahData.length;
        }

        // Refresh All Tables
        function refreshAllTables() {
            loadMahasiswaTable();
            loadKurikulumTable();
            loadUserTable();
            populateSelectors();
        }

        // Load Mahasiswa Table
        function loadMahasiswaTable() {
            const tbody = document.getElementById('mahasiswaTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            mahasiswaData.forEach((mahasiswa, index) => {
                const row = `
                    <tr>
                        <td>${mahasiswa.nim}</td>
                        <td>${mahasiswa.nama}</td>
                        <td>${mahasiswa.angkatan}</td>
                        <td>${mahasiswa.semester}</td>
                        <td>${mahasiswa.status}</td>
                        <td class="action-buttons">
                            <button class="btn btn-sm btn-info" onclick="editMahasiswa(${index})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteMahasiswa(${index})">Hapus</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // Load Kurikulum Table
        function loadKurikulumTable() {
            const tbody = document.getElementById('kurikulumTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            mataKuliahData.forEach((mk, index) => {
                const row = `
                    <tr>
                        <td>${mk.kode}</td>
                        <td>${mk.nama}</td>
                        <td>${mk.sks}</td>
                        <td>${mk.semester}</td>
                        <td>${mk.prasyarat}</td>
                        <td class="action-buttons">
                            <button class="btn btn-sm btn-info" onclick="editMataKuliah(${index})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteMataKuliah(${index})">Hapus</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // Load User Table
        function loadUserTable() {
            const tbody = document.getElementById('userTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            userData.forEach((user, index) => {
                const row = `
                    <tr>
                        <td>${user.username}</td>
                        <td>${user.role}</td>
                        <td>${user.status}</td>
                        <td class="action-buttons">
                            <button class="btn btn-sm btn-info" onclick="editUser(${index})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteUser(${index})">Hapus</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // Populate Selectors
        function populateSelectors() {
            // Populate mahasiswa selectors
            const mahasiswaSelectors = ['krsMahasiswa', 'khsMahasiswa', 'transkripMahasiswa', 'cetakMahasiswa'];
            mahasiswaSelectors.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                if (selector) {
                    selector.innerHTML = '<option value="">Pilih Mahasiswa</option>';
                    mahasiswaData.forEach(mahasiswa => {
                        selector.innerHTML += `<option value="${mahasiswa.nim}">${mahasiswa.nim} - ${mahasiswa.nama}</option>`;
                    });
                }
            });

            // Populate mata kuliah selector for nilai
            const mkSelector = document.getElementById('nilaiMataKuliah');
            if (mkSelector) {
                mkSelector.innerHTML = '<option value="">Pilih Mata Kuliah</option>';
                mataKuliahData.forEach(mk => {
                    mkSelector.innerHTML += `<option value="${mk.kode}">${mk.kode} - ${mk.nama}</option>`;
                });
            }
        }

        // Modal Functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'block';
                
                // Reset form title and edit index if opening add modals
                if (modalId === 'addMahasiswaModal') {
                    document.getElementById('addMahasiswaModal').querySelector('h3').textContent = 'Tambah Mahasiswa';
                    delete document.getElementById('addMahasiswaForm').dataset.editIndex;
                } else if (modalId === 'addMataKuliahModal') {
                    document.getElementById('addMataKuliahModal').querySelector('h3').textContent = 'Tambah Mata Kuliah';
                    delete document.getElementById('addMataKuliahForm').dataset.editIndex;
                } else if (modalId === 'addUserModal') {
                    document.getElementById('addUserModal').querySelector('h3').textContent = 'Tambah User';
                    delete document.getElementById('addUserForm').dataset.editIndex;
                }
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                
                // Reset form if it exists
                const form = modal.querySelector('form');
                if (form) {
                    form.reset();
                    delete form.dataset.editIndex;
                }
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Form Submissions
        document.getElementById('addMahasiswaForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const editIndex = this.dataset.editIndex;
            const newMahasiswa = {
                nim: document.getElementById('newNim').value,
                nama: document.getElementById('newNama').value,
                angkatan: parseInt(document.getElementById('newAngkatan').value),
                semester: parseInt(document.getElementById('newSemester').value),
                status: 'Aktif',
                password: 'mahasiswa123'
            };
            
            if (editIndex !== undefined) {
                // Update existing mahasiswa
                const oldNim = mahasiswaData[editIndex].nim;
                mahasiswaData[editIndex] = newMahasiswa;
                
                // Update userData if NIM changed
                if (oldNim !== newMahasiswa.nim) {
                    const userIndex = userData.findIndex(u => u.username === oldNim);
                    if (userIndex !== -1) {
                        userData[userIndex].username = newMahasiswa.nim;
                    }
                    
                    // Update KRS and Nilai data keys
                    if (krsData[oldNim]) {
                        krsData[newMahasiswa.nim] = krsData[oldNim];
                        delete krsData[oldNim];
                    }
                    if (nilaiData[oldNim]) {
                        nilaiData[newMahasiswa.nim] = nilaiData[oldNim];
                        delete nilaiData[oldNim];
                    }
                }
                
                alert('Mahasiswa berhasil diupdate!');
            } else {
                // Add new mahasiswa
                if (mahasiswaData.find(m => m.nim === newMahasiswa.nim)) {
                    alert('NIM sudah ada!');
                    return;
                }
                
                mahasiswaData.push(newMahasiswa);
                userData.push({
                    username: newMahasiswa.nim,
                    password: 'mahasiswa123',
                    role: 'mahasiswa',
                    status: 'Aktif'
                });
                alert('Mahasiswa berhasil ditambahkan!');
            }
            
            saveAllData();
            loadMahasiswaTable();
            loadUserTable();
            populateSelectors();
            closeModal('addMahasiswaModal');
        });

        document.getElementById('addMataKuliahForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const editIndex = this.dataset.editIndex;
            const newMataKuliah = {
                kode: document.getElementById('newKodeMK').value,
                nama: document.getElementById('newNamaMK').value,
                sks: parseInt(document.getElementById('newSKS').value),
                semester: parseInt(document.getElementById('newSemesterMK').value),
                prasyarat: document.getElementById('newPrasyarat').value || '-'
            };
            
            if (editIndex !== undefined) {
                // Update existing mata kuliah
                mataKuliahData[editIndex] = newMataKuliah;
                alert('Mata kuliah berhasil diupdate!');
            } else {
                // Add new mata kuliah
                if (mataKuliahData.find(mk => mk.kode === newMataKuliah.kode)) {
                    alert('Kode mata kuliah sudah ada!');
                    return;
                }
                
                mataKuliahData.push(newMataKuliah);
                alert('Mata kuliah berhasil ditambahkan!');
            }
            
            saveAllData();
            loadKurikulumTable();
            populateSelectors();
            closeModal('addMataKuliahModal');
        });

        document.getElementById('addUserForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const editIndex = this.dataset.editIndex;
            const newUser = {
                username: document.getElementById('newUsername').value,
                password: document.getElementById('newPassword').value,
                role: document.getElementById('newRole').value,
                status: 'Aktif'
            };
            
            if (editIndex !== undefined) {
                // Update existing user
                userData[editIndex] = newUser;
                alert('User berhasil diupdate!');
            } else {
                // Add new user
                if (userData.find(u => u.username === newUser.username)) {
                    alert('Username sudah ada!');
                    return;
                }
                
                userData.push(newUser);
                alert('User berhasil ditambahkan!');
            }
            
            saveAllData();
            loadUserTable();
            closeModal('addUserModal');
        });

        document.getElementById('editKopForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            kopSurat = {
                namaInstitusi: document.getElementById('namaInstitusi').value,
                namaProdi: document.getElementById('namaProdi').value,
                alamat: document.getElementById('alamatInstitusi').value,
                kaprodi: document.getElementById('namaKaprodi').value
            };
            
            saveAllData();
            closeModal('editKopModal');
            alert('Kop surat berhasil diperbarui!');
        });

        // CRUD Functions
        function editMahasiswa(index) {
            const mahasiswa = mahasiswaData[index];
            document.getElementById('newNim').value = mahasiswa.nim;
            document.getElementById('newNama').value = mahasiswa.nama;
            document.getElementById('newAngkatan').value = mahasiswa.angkatan;
            document.getElementById('newSemester').value = mahasiswa.semester;
            
            document.getElementById('addMahasiswaForm').dataset.editIndex = index;
            document.getElementById('addMahasiswaModal').querySelector('h3').textContent = 'Edit Mahasiswa';
            
            openModal('addMahasiswaModal');
        }

        function deleteMahasiswa(index) {
            if (confirm('Apakah Anda yakin ingin menghapus mahasiswa ini?')) {
                const mahasiswa = mahasiswaData[index];
                
                // Remove from mahasiswaData
                mahasiswaData.splice(index, 1);
                
                // Remove from userData
                const userIndex = userData.findIndex(u => u.username === mahasiswa.nim);
                if (userIndex !== -1) {
                    userData.splice(userIndex, 1);
                }
                
                // Remove from krsData and nilaiData
                delete krsData[mahasiswa.nim];
                delete nilaiData[mahasiswa.nim];
                
                saveAllData();
                loadMahasiswaTable();
                loadUserTable();
                populateSelectors();
                alert('Mahasiswa berhasil dihapus!');
            }
        }

        function editMataKuliah(index) {
            const mk = mataKuliahData[index];
            document.getElementById('newKodeMK').value = mk.kode;
            document.getElementById('newNamaMK').value = mk.nama;
            document.getElementById('newSKS').value = mk.sks;
            document.getElementById('newSemesterMK').value = mk.semester;
            document.getElementById('newPrasyarat').value = mk.prasyarat;
            
            document.getElementById('addMataKuliahForm').dataset.editIndex = index;
            document.getElementById('addMataKuliahModal').querySelector('h3').textContent = 'Edit Mata Kuliah';
            
            openModal('addMataKuliahModal');
        }

        function deleteMataKuliah(index) {
            if (confirm('Apakah Anda yakin ingin menghapus mata kuliah ini?')) {
                mataKuliahData.splice(index, 1);
                saveAllData();
                loadKurikulumTable();
                populateSelectors();
                alert('Mata kuliah berhasil dihapus!');
            }
        }

        function editUser(index) {
            const user = userData[index];
            document.getElementById('newUsername').value = user.username;
            document.getElementById('newPassword').value = user.password;
            document.getElementById('newRole').value = user.role;
            
            document.getElementById('addUserForm').dataset.editIndex = index;
            document.getElementById('addUserModal').querySelector('h3').textContent = 'Edit User';
            
            openModal('addUserModal');
        }

        function deleteUser(index) {
            if (confirm('Apakah Anda yakin ingin menghapus user ini?')) {
                userData.splice(index, 1);
                saveAllData();
                loadUserTable();
                alert('User berhasil dihapus!');
            }
        }

        // KRS Functions
        function loadKRSData() {
            if (currentRole === 'mahasiswa') {
                document.getElementById('krsAdmin').style.display = 'none';
                const mahasiswa = mahasiswaData.find(m => m.nama === currentUser);
                if (mahasiswa) {
                    loadAvailableMataKuliah(mahasiswa.nim, mahasiswa.semester);
                }
            } else {
                document.getElementById('krsAdmin').style.display = 'block';
                document.getElementById('krsContent').style.display = 'block';
            }
        }

        function loadKRSForStudent() {
            const nim = document.getElementById('krsMahasiswa').value;
            if (!nim) {
                return;
            }
            
            const mahasiswa = mahasiswaData.find(m => m.nim === nim);
            if (mahasiswa) {
                loadAvailableMataKuliah(nim, mahasiswa.semester);
            }
        }

        function loadAvailableMataKuliah(nim, semester) {
            const tbody = document.getElementById('availableMataKuliahBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const availableMK = mataKuliahData.filter(mk => mk.semester <= semester);
            const currentKRS = krsData[nim] && krsData[nim][semester] ? krsData[nim][semester] : [];
            
            availableMK.forEach(mk => {
                const isSelected = currentKRS.includes(mk.kode);
                const row = `
                    <tr>
                        <td><input type="checkbox" name="selectedMK" value="${mk.kode}" ${isSelected ? 'checked' : ''}></td>
                        <td>${mk.kode}</td>
                        <td>${mk.nama}</td>
                        <td>${mk.sks}</td>
                        <td>${mk.semester}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function saveKRS() {
            const selectedMK = Array.from(document.querySelectorAll('input[name="selectedMK"]:checked')).map(cb => cb.value);
            
            let targetNim;
            if (currentRole === 'admin') {
                targetNim = document.getElementById('krsMahasiswa').value;
                if (!targetNim) {
                    alert('Pilih mahasiswa terlebih dahulu!');
                    return;
                }
            } else {
                const mahasiswa = mahasiswaData.find(m => m.nama === currentUser);
                targetNim = mahasiswa.nim;
            }
            
            if (selectedMK.length === 0) {
                alert('Pilih minimal satu mata kuliah!');
                return;
            }
            
            if (!krsData[targetNim]) {
                krsData[targetNim] = {};
            }
            
            const mahasiswa = mahasiswaData.find(m => m.nim === targetNim);
            krsData[targetNim][mahasiswa.semester] = selectedMK;
            
            saveAllData();
            alert('KRS berhasil disimpan!');
        }

        // Pengisian Nilai Functions
        function loadPengisianNilaiData() {
            document.getElementById('nilaiContent').style.display = 'none';
        }

        function loadNilaiData() {
            const angkatan = document.getElementById('nilaiAngkatan').value;
            const semester = document.getElementById('nilaiSemester').value;
            const mataKuliah = document.getElementById('nilaiMataKuliah').value;
            
            if (!angkatan || !semester || !mataKuliah) {
                document.getElementById('nilaiContent').style.display = 'none';
                return;
            }
            
            document.getElementById('nilaiContent').style.display = 'block';
            
            const mahasiswaFiltered = mahasiswaData.filter(m => 
                m.angkatan.toString() === angkatan && m.semester >= parseInt(semester)
            );
            
            const tbody = document.getElementById('nilaiTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            mahasiswaFiltered.forEach(mahasiswa => {
                const currentNilai = nilaiData[mahasiswa.nim] && nilaiData[mahasiswa.nim][mataKuliah] 
                    ? nilaiData[mahasiswa.nim][mataKuliah] : '';
                const currentGrade = convertToGrade(currentNilai);
                
                const row = `
                    <tr>
                        <td>${mahasiswa.nim}</td>
                        <td>${mahasiswa.nama}</td>
                        <td><input type="number" min="0" max="100" value="${currentNilai}" id="nilai_${mahasiswa.nim}"></td>
                        <td><span id="grade_${mahasiswa.nim}">${currentGrade}</span></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            
            // Add event listeners for grade calculation
            mahasiswaFiltered.forEach(mahasiswa => {
                const input = document.getElementById(`nilai_${mahasiswa.nim}`);
                if (input) {
                    input.addEventListener('input', function() {
                        const nilai = this.value;
                        const gradeSpan = document.getElementById(`grade_${mahasiswa.nim}`);
                        if (gradeSpan) {
                            gradeSpan.textContent = convertToGrade(nilai);
                        }
                    });
                }
            });
        }

        function convertToGrade(nilai) {
            if (!nilai || nilai === '') return '';
            const n = parseInt(nilai);
            if (n >= 85) return 'A';
            if (n >= 70) return 'B';
            if (n >= 55) return 'C';
            if (n >= 40) return 'D';
            return 'E';
        }

        function saveNilai() {
            const angkatan = document.getElementById('nilaiAngkatan').value;
            const mataKuliah = document.getElementById('nilaiMataKuliah').value;
            
            const mahasiswaFiltered = mahasiswaData.filter(m => m.angkatan.toString() === angkatan);
            
            mahasiswaFiltered.forEach(mahasiswa => {
                const nilaiInput = document.getElementById(`nilai_${mahasiswa.nim}`);
                if (nilaiInput && nilaiInput.value) {
                    if (!nilaiData[mahasiswa.nim]) {
                        nilaiData[mahasiswa.nim] = {};
                    }
                    nilaiData[mahasiswa.nim][mataKuliah] = parseInt(nilaiInput.value);
                }
            });
            
            saveAllData();
            alert('Nilai berhasil disimpan!');
        }

        // KHS Functions
        function loadKHSData() {
            if (currentRole === 'mahasiswa') {
                document.getElementById('khsAdmin').style.display = 'none';
                const mahasiswa = mahasiswaData.find(m => m.nama === currentUser);
                if (mahasiswa) {
                    loadKHSForMahasiswa(mahasiswa.nim, mahasiswa.semester);
                }
            } else {
                document.getElementById('khsAdmin').style.display = 'block';
                document.getElementById('khsContent').style.display = 'none';
            }
        }

        function loadKHS() {
            const nim = document.getElementById('khsMahasiswa').value;
            const semester = document.getElementById('khsSemester').value;
            
            if (!nim || !semester) {
                document.getElementById('khsContent').style.display = 'none';
                return;
            }
            
            loadKHSForMahasiswa(nim, semester);
        }

        function loadKHSForMahasiswa(nim, semester) {
            document.getElementById('khsContent').style.display = 'block';
            
            const tbody = document.getElementById('khsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const mahasiswaMK = krsData[nim] && krsData[nim][semester] ? krsData[nim][semester] : [];
            let totalSKS = 0;
            let totalNilai = 0;
            
            mahasiswaMK.forEach(kodeMK => {
                const mk = mataKuliahData.find(m => m.kode === kodeMK);
                const nilai = nilaiData[nim] && nilaiData[nim][kodeMK] ? nilaiData[nim][kodeMK] : 0;
                const grade = convertToGrade(nilai);
                
                if (mk) {
                    totalSKS += mk.sks;
                    totalNilai += nilai * mk.sks;
                    
                    const row = `
                        <tr>
                            <td>${mk.kode}</td>
                            <td>${mk.nama}</td>
                            <td>${mk.sks}</td>
                            <td>${nilai}</td>
                            <td>${grade}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                }
            });
            
            const ipk = totalSKS > 0 ? (totalNilai / totalSKS / 25).toFixed(2) : '0.00';
            const totalSKSElement = document.getElementById('totalSKS');
            const ipkSemesterElement = document.getElementById('ipkSemester');
            
            if (totalSKSElement) totalSKSElement.textContent = totalSKS;
            if (ipkSemesterElement) ipkSemesterElement.textContent = ipk;
        }

        // Transkrip Functions
        function loadTranskripData() {
            if (currentRole === 'mahasiswa') {
                document.getElementById('transkripAdmin').style.display = 'none';
                const mahasiswa = mahasiswaData.find(m => m.nama === currentUser);
                if (mahasiswa) {
                    loadTranskripForMahasiswa(mahasiswa.nim);
                }
            } else {
                document.getElementById('transkripAdmin').style.display = 'block';
                document.getElementById('transkripContent').style.display = 'none';
            }
        }

        function loadTranskrip() {
            const nim = document.getElementById('transkripMahasiswa').value;
            if (!nim) {
                document.getElementById('transkripContent').style.display = 'none';
                return;
            }
            loadTranskripForMahasiswa(nim);
        }

        function loadTranskripForMahasiswa(nim) {
            document.getElementById('transkripContent').style.display = 'block';
            
            const tbody = document.getElementById('transkripTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            let totalSKS = 0;
            let totalNilai = 0;
            
            // Get all semesters for this mahasiswa
            if (krsData[nim]) {
                Object.keys(krsData[nim]).forEach(semester => {
                    const mahasiswaMK = krsData[nim][semester];
                    
                    mahasiswaMK.forEach(kodeMK => {
                        const mk = mataKuliahData.find(m => m.kode === kodeMK);
                        const nilai = nilaiData[nim] && nilaiData[nim][kodeMK] ? nilaiData[nim][kodeMK] : 0;
                        const grade = convertToGrade(nilai);
                        
                        if (mk) {
                            totalSKS += mk.sks;
                            totalNilai += nilai * mk.sks;
                            
                            const row = `
                                <tr>
                                    <td>${semester}</td>
                                    <td>${mk.kode}</td>
                                    <td>${mk.nama}</td>
                                    <td>${mk.sks}</td>
                                    <td>${nilai}</td>
                                    <td>${grade}</td>
                                </tr>
                            `;
                            tbody.innerHTML += row;
                        }
                    });
                });
            }
            
            const ipk = totalSKS > 0 ? (totalNilai / totalSKS / 25).toFixed(2) : '0.00';
            const totalSKSElement = document.getElementById('totalSKSTranskrip');
            const ipkElement = document.getElementById('ipkKumulatif');
            
            if (totalSKSElement) totalSKSElement.textContent = totalSKS;
            if (ipkElement) ipkElement.textContent = ipk;
        }

        // Cetak Functions
        function loadCetakData() {
            populateSelectors();
        }

        function generatePDF() {
            const jenis = document.getElementById('jenisCetak').value;
            const nim = document.getElementById('cetakMahasiswa').value;
            
            if (!jenis || !nim) {
                alert('Pilih jenis dokumen dan mahasiswa!');
                return;
            }
            
            const mahasiswa = mahasiswaData.find(m => m.nim === nim);
            if (!mahasiswa) {
                alert('Mahasiswa tidak ditemukan!');
                return;
            }
            
            generatePrintPreview(jenis, mahasiswa);
        }

        function generatePrintPreview(jenis, mahasiswa) {
            const printPreview = document.getElementById('printPreview');
            let content = generateKopSurat();
            
            switch(jenis) {
                case 'dataMahasiswa':
                    content += generateDataMahasiswaContent(mahasiswa);
                    break;
                case 'krs':
                    content += generateKRSContent(mahasiswa);
                    break;
                case 'khs':
                    content += generateKHSContent(mahasiswa);
                    break;
                case 'transkrip':
                    content += generateTranskripContent(mahasiswa);
                    break;
            }
            
            content += generateSignatureArea();
            
            printPreview.innerHTML = content;
            printPreview.style.display = 'block';
            
            setTimeout(() => {
                window.print();
            }, 500);
        }

        function generateKopSurat() {
            return `
                <div class="kop-surat">
                    <h2>${kopSurat.namaInstitusi}</h2>
                    <h3>${kopSurat.namaProdi}</h3>
                    <p>${kopSurat.alamat}</p>
                </div>
            `;
        }

        function generateDataMahasiswaContent(mahasiswa) {
            return `
                <h3 style="text-align: center; margin-bottom: 30px;">DATA MAHASISWA</h3>
                <table style="width: 100%; border: none;">
                    <tr>
                        <td style="border: none; padding: 10px 0; width: 30%;"><strong>NIM</strong></td>
                        <td style="border: none; padding: 10px 0;">: ${mahasiswa.nim}</td>
                    </tr>
                    <tr>
                        <td style="border: none; padding: 10px 0;"><strong>Nama</strong></td>
                        <td style="border: none; padding: 10px 0;">: ${mahasiswa.nama}</td>
                    </tr>
                    <tr>
                        <td style="border: none; padding: 10px 0;"><strong>Angkatan</strong></td>
                        <td style="border: none; padding: 10px 0;">: ${mahasiswa.angkatan}</td>
                    </tr>
                    <tr>
                        <td style="border: none; padding: 10px 0;"><strong>Semester</strong></td>
                        <td style="border: none; padding: 10px 0;">: ${mahasiswa.semester}</td>
                    </tr>
                    <tr>
                        <td style="border: none; padding: 10px 0;"><strong>Status</strong></td>
                        <td style="border: none; padding: 10px 0;">: ${mahasiswa.status}</td>
                    </tr>
                </table>
            `;
        }

        function generateKRSContent(mahasiswa) {
            let content = `
                <h3 style="text-align: center; margin-bottom: 30px;">KARTU RENCANA STUDI (KRS)</h3>
                <p><strong>NIM:</strong> ${mahasiswa.nim}</p>
                <p><strong>Nama:</strong> ${mahasiswa.nama}</p>
                <p><strong>Semester:</strong> ${mahasiswa.semester}</p>
                <br>
                <table>
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Kode</th>
                            <th>Mata Kuliah</th>
                            <th>SKS</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const mahasiswaMK = krsData[mahasiswa.nim] && krsData[mahasiswa.nim][mahasiswa.semester] 
                ? krsData[mahasiswa.nim][mahasiswa.semester] : [];
            let totalSKS = 0;
            
            mahasiswaMK.forEach((kodeMK, index) => {
                const mk = mataKuliahData.find(m => m.kode === kodeMK);
                if (mk) {
                    totalSKS += mk.sks;
                    content += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${mk.kode}</td>
                            <td>${mk.nama}</td>
                            <td>${mk.sks}</td>
                        </tr>
                    `;
                }
            });
            
            content += `
                    </tbody>
                </table>
                <p style="margin-top: 20px;"><strong>Total SKS: ${totalSKS}</strong></p>
            `;
            
            return content;
        }

        function generateKHSContent(mahasiswa) {
            let content = `
                <h3 style="text-align: center; margin-bottom: 30px;">KARTU HASIL STUDI (KHS)</h3>
                <p><strong>NIM:</strong> ${mahasiswa.nim}</p>
                <p><strong>Nama:</strong> ${mahasiswa.nama}</p>
                <p><strong>Semester:</strong> ${mahasiswa.semester}</p>
                <br>
                <table>
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Kode</th>
                            <th>Mata Kuliah</th>
                            <th>SKS</th>
                            <th>Nilai</th>
                            <th>Grade</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const mahasiswaMK = krsData[mahasiswa.nim] && krsData[mahasiswa.nim][mahasiswa.semester] 
                ? krsData[mahasiswa.nim][mahasiswa.semester] : [];
            let totalSKS = 0;
            let totalNilai = 0;
            
            mahasiswaMK.forEach((kodeMK, index) => {
                const mk = mataKuliahData.find(m => m.kode === kodeMK);
                const nilai = nilaiData[mahasiswa.nim] && nilaiData[mahasiswa.nim][kodeMK] 
                    ? nilaiData[mahasiswa.nim][kodeMK] : 0;
                const grade = convertToGrade(nilai);
                
                if (mk) {
                    totalSKS += mk.sks;
                    totalNilai += nilai * mk.sks;
                    content += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${mk.kode}</td>
                            <td>${mk.nama}</td>
                            <td>${mk.sks}</td>
                            <td>${nilai}</td>
                            <td>${grade}</td>
                        </tr>
                    `;
                }
            });
            
            const ipk = totalSKS > 0 ? (totalNilai / totalSKS / 25).toFixed(2) : '0.00';
            
            content += `
                    </tbody>
                </table>
                <p style="margin-top: 20px;"><strong>Total SKS: ${totalSKS}</strong></p>
                <p><strong>IPK Semester: ${ipk}</strong></p>
            `;
            
            return content;
        }

        function generateTranskripContent(mahasiswa) {
            let content = `
                <h3 style="text-align: center; margin-bottom: 30px;">TRANSKRIP NILAI</h3>
                <p><strong>NIM:</strong> ${mahasiswa.nim}</p>
                <p><strong>Nama:</strong> ${mahasiswa.nama}</p>
                <br>
                <table>
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Semester</th>
                            <th>Kode</th>
                            <th>Mata Kuliah</th>
                            <th>SKS</th>
                            <th>Nilai</th>
                            <th>Grade</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let totalSKS = 0;
            let totalNilai = 0;
            let rowIndex = 0;
            
            if (krsData[mahasiswa.nim]) {
                Object.keys(krsData[mahasiswa.nim]).forEach(semester => {
                    const mahasiswaMK = krsData[mahasiswa.nim][semester];
                    
                    mahasiswaMK.forEach(kodeMK => {
                        const mk = mataKuliahData.find(m => m.kode === kodeMK);
                        const nilai = nilaiData[mahasiswa.nim] && nilaiData[mahasiswa.nim][kodeMK] 
                            ? nilaiData[mahasiswa.nim][kodeMK] : 0;
                        const grade = convertToGrade(nilai);
                        
                        if (mk) {
                            totalSKS += mk.sks;
                            totalNilai += nilai * mk.sks;
                            rowIndex++;
                            content += `
                                <tr>
                                    <td>${rowIndex}</td>
                                    <td>${semester}</td>
                                    <td>${mk.kode}</td>
                                    <td>${mk.nama}</td>
                                    <td>${mk.sks}</td>
                                    <td>${nilai}</td>
                                    <td>${grade}</td>
                                </tr>
                            `;
                        }
                    });
                });
            }
            
            const ipk = totalSKS > 0 ? (totalNilai / totalSKS / 25).toFixed(2) : '0.00';
            
            content += `
                    </tbody>
                </table>
                <p style="margin-top: 20px;"><strong>Total SKS: ${totalSKS}</strong></p>
                <p><strong>IPK Kumulatif: ${ipk}</strong></p>
            `;
            
            return content;
        }

        function generateSignatureArea() {
            const today = new Date();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                locale: 'id-ID'
            };
            const dateStr = today.toLocaleDateString('id-ID', options);
            
            return `
                <div class="signature-area">
                    <div class="signature-box">
                        <p>Mahasiswa,</p>
                        <div class="signature-line">
                            <p>(Nama Mahasiswa)</p>
                        </div>
                    </div>
                    <div class="signature-box">
                        <p>Jakarta, ${dateStr}</p>
                        <p>Ketua Program Studi</p>
                        <div class="signature-line">
                            <p>${kopSurat.kaprodi}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Pengaturan Functions
        function loadPengaturanData() {
            loadUserTable();
            
            // Load current kop surat values
            document.getElementById('namaInstitusi').value = kopSurat.namaInstitusi;
            document.getElementById('namaProdi').value = kopSurat.namaProdi;
            document.getElementById('alamatInstitusi').value = kopSurat.alamat;
            document.getElementById('namaKaprodi').value = kopSurat.kaprodi;
        }

        // Reset and Export Functions
        function resetMahasiswaData() {
            if (confirm('Apakah Anda yakin ingin mereset semua data mahasiswa? Data ini tidak dapat dikembalikan!')) {
                // Remove all mahasiswa except admin
                const adminUsers = userData.filter(u => u.role === 'admin');
                mahasiswaData = [];
                userData = adminUsers;
                krsData = {};
                nilaiData = {};
                
                saveAllData();
                loadMahasiswaTable();
                loadUserTable();
                populateSelectors();
                loadDashboardData();
                alert('Data mahasiswa berhasil direset!');
            }
        }

        function resetKurikulumData() {
            if (confirm('Apakah Anda yakin ingin mereset semua data kurikulum? Data ini tidak dapat dikembalikan!')) {
                mataKuliahData = [];
                krsData = {};
                nilaiData = {};
                
                saveAllData();
                loadKurikulumTable();
                populateSelectors();
                loadDashboardData();
                alert('Data kurikulum berhasil direset!');
            }
        }

        function resetUserData() {
            if (confirm('Apakah Anda yakin ingin mereset data user? Hanya admin yang akan tersisa!')) {
                userData = userData.filter(u => u.role === 'admin');
                
                saveAllData();
                loadUserTable();
                alert('Data user berhasil direset!');
            }
        }

        function resetAllData() {
            if (confirm('Apakah Anda yakin ingin mereset SEMUA data sistem? Data ini tidak dapat dikembalikan!')) {
                if (confirm('Konfirmasi sekali lagi: SEMUA data akan dihapus termasuk mahasiswa, mata kuliah, KRS, dan nilai!')) {
                    // Clear all localStorage
                    Object.values(STORAGE_KEYS).forEach(key => {
                        localStorage.removeItem(key);
                    });
                    
                    // Reinitialize with default data
                    initializeDefaultData();
                    
                    // Refresh all displays
                    refreshAllTables();
                    loadDashboardData();
                    
                    alert('Semua data berhasil direset ke data default!');
                }
            }
        }

        function exportMahasiswaData() {
            const data = {
                mahasiswa: mahasiswaData,
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `data_mahasiswa_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportKurikulumData() {
            const data = {
                mataKuliah: mataKuliahData,
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `data_kurikulum_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Backup Functions
        function downloadBackup() {
            const backupData = {
                mahasiswaData: mahasiswaData,
                mataKuliahData: mataKuliahData,
                userData: userData,
                krsData: krsData,
                nilaiData: nilaiData,
                kopSurat: kopSurat,
                timestamp: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(backupData, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_akademik_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Backup berhasil didownload!');
        }

        function uploadBackup() {
            const file = document.getElementById('backupFile').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // Validate backup structure
                    if (!backupData.mahasiswaData || !backupData.mataKuliahData || !backupData.userData) {
                        throw new Error('Invalid backup format');
                    }
                    
                    // Restore data
                    mahasiswaData = backupData.mahasiswaData;
                    mataKuliahData = backupData.mataKuliahData;
                    userData = backupData.userData;
                    krsData = backupData.krsData || {};
                    nilaiData = backupData.nilaiData || {};
                    kopSurat = backupData.kopSurat || kopSurat;
                    
                    // Save to localStorage
                    saveAllData();
                    
                    // Reload all data
                    refreshAllTables();
                    loadDashboardData();
                    
                    alert('Backup berhasil dipulihkan!');
                } catch (error) {
                    alert('Error: File backup tidak valid! ' + error.message);
                }
                
                // Clear file input
                document.getElementById('backupFile').value = '';
            };
            reader.readAsText(file);
        }

        // Initialize the system when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize data from localStorage or defaults
            initializeDefaultData();
            
            // Set initial focus on username field
            document.getElementById('username').focus();
            
            // Add enter key handling for login
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && document.getElementById('loginPage').style.display !== 'none') {
                    document.getElementById('loginForm').dispatchEvent(new Event('submit'));
                }
            });
            
            // Auto-save data every 30 seconds
            setInterval(saveAllData, 30000);
            
            console.log('Sistem Akademik loaded successfully with persistent storage');
        });

        // Save data before page unload
        window.addEventListener('beforeunload', function() {
            saveAllData();
        });
    </script>
</body>
</html>